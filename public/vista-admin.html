<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventario - Administrador</title>
  <link rel="stylesheet" href="vista_admin.css">
  <link href="https://fonts.googleapis.com/css2?family=Jost:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header class="encabezado">
    <h1>LATOSOS CO</h1>
    <img src="GuardianIcon.png" alt="Escudo" class="icono-escudo">
  </header>

  <main class="contenido">
    <section class="caja-principal">
      <div class="barra-superior">
        <button class="btn-regresar" onclick="window.location.href='seleccion_usuario.html'">&#8592;</button>

        <div class="busqueda">
          <input type="text" placeholder="Ingrese lo que desee buscar..." id="searchInput" onkeyup="searchTable()">
          <span class="btn-cerrar">√ó</span>
        </div>

        <div class="acciones"> 
          <button onclick="document.getElementById('importCSV').click()">Importar...</button>
          <input type="file" id="importCSV" accept=".csv" style="display: none;" onchange="importarCSV(event)">
          <button onclick="exportarCSV()">Exportar...</button>
          <button onclick="window.location.href='historial_cambios.html'">Historial de cambios</button>
          <button onclick="mostrarFormularioCrear()">Crear desde cero</button>


        </div>

        <img src="Casco admin.jpg" class="icono-perfil" alt="Perfil">
      </div>

      <div class="info-inventario">
        <div>
          <p><strong>ID del Inventario:</strong></p>
          <div class="id-contenedor">
            <span id="inventoryID">45TYUY64XS</span>
            <button onclick="copiarID()">üìã</button>
          </div>
        </div>
        <div>
          <p><strong>Descripci√≥n:</strong></p>
          <p class="descripcion-texto">
            El inventario de llantas registra productos disponibles en distintas categor√≠as para venta directa y por encargo.
            Aqu√≠ se gestionan cantidades, rangos aceptables y precios por unidad.
          </p>
        </div>
      </div>

      <div class="tabla-container">
        <div class="tabla-container" id="tablaContenedor">
          <p id="mensajePlaceholder">Tu inventario se mostrar√° aqu√≠</p>
        </div>        
      </div>
      <div id="formularioCrear" style="display:none; margin-top: 20px;">
        <label for="camposPersonalizados"><strong>Escribe los nombres de las columnas, separados por comas:</strong></label>
        <input type="text" id="camposPersonalizados" placeholder="Ej: C√≥digo, Producto, Precio" style="width: 100%; padding: 10px; margin-top: 10px;"/>
        <button onclick="crearTablaDesdeCero()" style="margin-top: 10px;">Crear tabla</button>
      </div>      
    </section>
  </main>

  <script>
    function copiarID() {
      const id = document.getElementById('inventoryID').innerText;
      navigator.clipboard.writeText(id);
    }

    function searchTable() {
      const input = document.getElementById("searchInput");
      const filter = input.value.toLowerCase();
      const table = document.getElementById("inventoryTable");
      const tr = table.getElementsByTagName("tr");

      for (let i = 1; i < tr.length; i++) {
        let visible = false;
        const td = tr[i].getElementsByTagName("td");
        for (let j = 0; j < td.length; j++) {
          if (td[j].innerText.toLowerCase().includes(filter)) {
            visible = true;
            break;
          }
        }
        tr[i].style.display = visible ? "" : "none";
      }
    }

  function eliminarFila(boton) {
    const fila = boton.closest("tr");
    registrarCambioHistorial(null, "ELIMINAR");
    fila.remove();
  }

  function agregarFila() {
    const tabla = document.getElementById("inventoryTable");
    if (!tabla) {
      alert("Primero debes importar un archivo CSV para generar la tabla.");
      return;
    }

    const tbody = tabla.querySelector("tbody");
    const encabezados = tabla.querySelectorAll("thead th");
    const columnas = encabezados.length - 2; // restar columna del bot√≥n ‚ùå

    const nuevaFila = document.createElement("tr");

    // Crear celda para bot√≥n eliminar
    const celdaEliminar = document.createElement("td");
    const btnEliminar = document.createElement("button");
    btnEliminar.textContent = "‚ùå";
    btnEliminar.onclick = function () {
      eliminarFila(btnEliminar);
    };

    celdaEliminar.appendChild(btnEliminar);
    nuevaFila.appendChild(celdaEliminar);

    // Crear celdas con inputs vac√≠os
    for (let i = 0; i < columnas; i++) {
      const td = document.createElement("td");
      const input = document.createElement("input");
      input.type = "text";
      td.appendChild(input);
      nuevaFila.appendChild(td);
    }

    // Insertar antes de la √∫ltima fila (la del bot√≥n ‚ûï)
    const filaAgregar = tbody.querySelector("tr:last-child");
    tbody.insertBefore(nuevaFila, filaAgregar);

    // A√±adir Enter para guardar fila
    const inputs = nuevaFila.querySelectorAll("input");
    inputs.forEach(input => {
      input.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          const valores = Array.from(inputs).map(i => i.value.trim());
          valores.forEach((valor, index) => {
            const td = inputs[index].parentElement;
            td.textContent = valor;
          });
          agregarFila();
        }
      });
    });
  } //Fin de la funcion agregar fila

  function moverCursorConFlechas(input, filaActual, columnaActual) {
    input.addEventListener("keydown", function (e) {
      if (!(e.altKey && ["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key))) return;

      e.preventDefault(); // Evitar comportamiento por defecto

      const tabla = document.getElementById("inventoryTable");
      const filas = Array.from(tabla.querySelector("tbody").rows).filter(f => f.querySelector("button")?.textContent !== "‚ûï");

      let nuevaFila = filaActual;
      let nuevaColumna = columnaActual;

      if (e.key === "ArrowUp" && filaActual > 0) nuevaFila--;
      else if (e.key === "ArrowDown" && filaActual < filas.length - 1) nuevaFila++;
      else if (e.key === "ArrowLeft" && columnaActual > 1) nuevaColumna--;
      else if (e.key === "ArrowRight" && columnaActual < filas[0].cells.length - 1) nuevaColumna++;

      // ‚úÖ Verificaci√≥n segura antes de editar
      if (nuevaFila !== filaActual || nuevaColumna !== columnaActual) {
        const celdaDestino = filas[nuevaFila]?.cells[nuevaColumna];
        if (celdaDestino && celdaDestino.tagName.toLowerCase() === "td") {
          activarEdicionCelda(celdaDestino);
        }
      }
    });
  }

  function activarEdicionCelda(celda) {
    const valorOriginal = celda.textContent;
    const input = document.createElement("input");
    input.type = "text";
    input.value = valorOriginal;
    celda.textContent = "";
    celda.appendChild(input);
    input.focus();

    const filaIndex = celda.parentElement.rowIndex - 1; // restamos el encabezado
    const colIndex = celda.cellIndex;

    moverCursorConFlechas(input, filaIndex, colIndex);

    input.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        celda.textContent = input.value.trim();
        const th = celda.closest("table").querySelectorAll("th")[celda.cellIndex];
        const nombreColumna = th ? th.innerText : null;
        if (input.value.trim() !== valorOriginal.trim()) {
          registrarCambioHistorial(nombreColumna, "MODIFICACION");
        }
      }
    });

    input.addEventListener("blur", function () {
      celda.textContent = input.value.trim();
    });
  }

  function habilitarEdicionTabla() {
    const tabla = document.getElementById("inventoryTable");
    if (!tabla) return;

    // Editar columnas (th)
    const ths = tabla.querySelectorAll("thead th");
    ths.forEach((th, index) => {
      if (index === 0 || th.querySelector("button")?.textContent === "‚ûï") return;

    th.addEventListener("dblclick", function () {
      const valorOriginal = th.textContent.trim();
      const input = document.createElement("input");
      input.type = "text";
      input.value = valorOriginal;
      th.textContent = "";
      th.appendChild(input);
      input.focus();

      const guardarCambio = () => {
        const nuevoValor = input.value.trim();
        th.textContent = nuevoValor !== "" ? nuevoValor : valorOriginal;
        // Si quieres registrar esto en historial:
        // registrarCambioHistorial("ENCABEZADO: " + valorOriginal, "MODIFICACION");
      };

      input.addEventListener("keydown", e => e.key === "Enter" && guardarCambio());
      input.addEventListener("blur", guardarCambio);
    });
  });

  // Editar celdas (td)
  tabla.addEventListener("dblclick", function (e) {
    const celda = e.target;
    // ‚õî Evitar editar si no es <td> o contiene un bot√≥n (‚ùå / ‚ûï)
    if (
      celda.tagName.toLowerCase() !== "td" ||
      celda.cellIndex === 0 ||
      celda.querySelector("button")
      ) {
        return;
      }

      activarEdicionCelda(celda);
    });
  }

  function exportarCSV() {
    const tabla = document.getElementById("inventoryTable");
    if (!tabla) {
      alert("No hay datos para exportar.");
      return;
    }

    let csv = [];
    const filas = tabla.querySelectorAll("tr");

    for (let i = 0; i < filas.length; i++) {
      const fila = filas[i];
      const celdas = fila.querySelectorAll("th, td");

      // Ignorar fila del bot√≥n ‚ûï
      if (fila.querySelector("button[onclick*='agregarFila']")) continue;

      let filaCSV = [];

      for (let j = 1; j < celdas.length; j++) {
        const celda = celdas[j];
        const input = celda.querySelector("input");
        if (input) {
          filaCSV.push(`"${input.value.trim()}"`);
        } else {
          filaCSV.push(`"${celda.textContent.trim()}"`);
        }
      }

      if (filaCSV.length > 0) {
        csv.push(filaCSV.join(","));
      }
    }

    if (csv.length === 0) {
      alert("No hay registros para exportar.");
      return;
    }

    // Agregar encabezado manualmente desde la tabla
    const headers = Array.from(tabla.querySelectorAll("thead th"))
      .slice(1) // omitimos la primera celda del ‚ùå
      .map(th => th.textContent.trim())
      .join(",");

    const contenidoCSV = [headers, ...csv].join("\n");
    const blob = new Blob([contenidoCSV], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "inventario.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  function agregarColumna() {
    const tabla = document.getElementById("inventoryTable");
    if (!tabla) return;

    // 1. Crear nuevo encabezado editable
    const thNueva = document.createElement("th");
    thNueva.innerHTML = '<span class="editable-header">Nueva columna</span>'; // Editable visual
    tabla.querySelector("thead tr").insertBefore(thNueva, tabla.querySelector("thead tr").lastElementChild); // Insertar antes del bot√≥n ‚ûï

    // 2. Agregar celda vac√≠a a cada fila del cuerpo
    const filas = tabla.querySelectorAll("tbody tr");
    filas.forEach((fila) => {
      const esUltima = fila.querySelector("button")?.textContent === "‚ûï";
      const tdNueva = document.createElement("td");
      
      if (!esUltima) {
        tdNueva.textContent = ""; // Campo vac√≠o
        const ultimaCelda = fila.querySelector("td:last-child");
        if (!esUltima && ultimaCelda && ultimaCelda.querySelector("button")?.textContent === "‚ûï") {
          fila.insertBefore(tdNueva, ultimaCelda);
        } else {
          fila.appendChild(tdNueva); // en filas normales, agr√©gala al final sin desplazar datos
        }
      } else {
        // Ajustar colspan para que siga centrado el bot√≥n ‚ûï
        const celdaColspan = fila.querySelector("td[colspan]");
        if (celdaColspan) {
          celdaColspan.colSpan = parseInt(celdaColspan.colSpan) + 1;
        }
      }
    });

    registrarCambioHistorial(null, "AGREGAR_COLUMNA");
    habilitarEdicionTabla(); // Reactivar la edici√≥n con doble clic para nuevas columnas
  }

  function importarCSV(event) {
    const archivo = event.target.files[0];
    if (!archivo || !archivo.name.endsWith(".csv")) {
      alert("Por favor selecciona un archivo CSV v√°lido.");
      return;
    }

    const reader = new FileReader();
    reader.onload = function (e) {
      const contenido = e.target.result.trim();
      const lineas = contenido.split("\n");
      if (lineas.length === 0) {
        alert("El archivo CSV est√° vac√≠o.");
        return;
      }

      const encabezados = lineas[0].split(",").map(h => h.replace(/"/g, "").trim());
      const tablaContenedor = document.getElementById("tablaContenedor");
      tablaContenedor.innerHTML = ""; // limpiar contenido previo

      const tabla = document.createElement("table");
      tabla.id = "inventoryTable";

      // Crear encabezado
      const thead = document.createElement("thead");
      const encabezadoFila = document.createElement("tr");
      encabezadoFila.innerHTML = `<th></th>` + encabezados.map(h => `<th>${h}</th>`).join("") + `<th><button onclick="agregarColumna()">‚ûï</button></th>`;
      thead.appendChild(encabezadoFila);
      tabla.appendChild(thead);

      // Crear cuerpo
      const tbody = document.createElement("tbody");
      for (let i = 1; i < lineas.length; i++) {
        const fila = document.createElement("tr");
        const datos = lineas[i].split(",").map(d => d.replace(/"/g, "").trim());
        if (datos.length !== encabezados.length) {
          alert(`La fila ${i + 1} no tiene el mismo n√∫mero de columnas que el encabezado.`);
          return;
        }

        fila.innerHTML = `
          <td><button onclick="eliminarFila(this)">‚ùå</button></td>
          ${datos.map(d => `<td>${d}</td>`).join("")}
        `;
        tbody.appendChild(fila);
      }

      // Fila para a√±adir m√°s
      const filaAgregar = document.createElement("tr");
      filaAgregar.innerHTML = `
        <td><button onclick="agregarFila()">‚ûï</button></td>
        <td colspan="${encabezados.length}"></td>
      `;
      
      tbody.appendChild(filaAgregar);

      tabla.appendChild(tbody);
      tablaContenedor.appendChild(tabla);

      registrarCambioHistorial(null, "IMPORTAR");
      habilitarEdicionTabla();
      event.target.value = ""; // reset input file
    };

    reader.readAsText(archivo);
  }

  // Funci√≥n para obtener fecha en formato DD/MM/YY
  function obtenerFechaActual() {
    const hoy = new Date();
    return hoy.toLocaleDateString("es-ES");
  }

  // Funci√≥n para guardar un nuevo cambio en localStorage
  function registrarCambioHistorial(columna, tipoAccion) {
    const historial = JSON.parse(localStorage.getItem("historialCambios")) || [];
    const nuevoCambio = {
      id: historial.length,
      columna_afectada: columna || null,
      fecha_accion: obtenerFechaActual(),
      id_inventario: document.getElementById("inventoryID").innerText.trim(),
      id_usuario: null, // se puede actualizar m√°s adelante si se tiene login
      tipo_accion: tipoAccion
    };
    historial.push(nuevoCambio);
    localStorage.setItem("historialCambios", JSON.stringify(historial));
  }

  function mostrarFormularioCrear() {
  document.getElementById("formularioCrear").style.display = "block";
}

function crearTablaDesdeCero() {
  const camposTexto = document.getElementById("camposPersonalizados").value.trim();
  if (!camposTexto) {
    alert("Debes ingresar al menos un nombre de columna.");
    return;
  }

  const encabezados = camposTexto.split(",").map(c => c.trim()).filter(c => c !== "");
  if (encabezados.length === 0) {
    alert("No se detectaron columnas v√°lidas.");
    return;
  }

  const tablaContenedor = document.getElementById("tablaContenedor");
  tablaContenedor.innerHTML = "";

  const tabla = document.createElement("table");
  tabla.id = "inventoryTable";

  const thead = document.createElement("thead");
  const trHead = document.createElement("tr");
  trHead.innerHTML = `<th></th>` + encabezados.map(c => `<th>${c}</th>`).join("") + `<th><button onclick="agregarColumna()">‚ûï</button></th>`;
  thead.appendChild(trHead);

  const tbody = document.createElement("tbody");

  const filaAgregar = document.createElement("tr");
  filaAgregar.innerHTML = `<td><button onclick="agregarFila()">‚ûï</button></td><td colspan="${encabezados.length}"></td>`;
  tbody.appendChild(filaAgregar);

  tabla.appendChild(thead);
  tabla.appendChild(tbody);
  tablaContenedor.appendChild(tabla);

  document.getElementById("formularioCrear").style.display = "none";
  document.getElementById("camposPersonalizados").value = "";
  registrarCambioHistorial(null, "CREAR DESDE CERO");
  habilitarEdicionTabla();
}



  </script>
</body>
</html>
