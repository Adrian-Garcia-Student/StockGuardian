<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Inventario - Invitado</title>
  <link rel="stylesheet" href="invitado.css" />
</head>
<body>
  <header class="encabezado">
    <h1 id="nombreEncabezado">...</h1>
    <img src="GuardianIcon.png" alt="Escudo" class="icono-escudo" />
  </header>

  <main class="contenido">
    <section class="caja-principal">
      <div class="barra-superior">
        <button class="btn-regresar" onclick="window.location.href='seleccion_usuario.html'">&#8592;</button>
        <div class="busqueda">
          <input type="text" placeholder="Ingrese lo que desee buscar..." id="searchInput" onkeyup="searchTable()" />
            <img class="icono-busqueda" src="Casco invitado.png" />
            <span class="btn-cerrar">√ó</span>
          </div>          
      </div>

      <div class="info-inventario">
        <div>
          <p class="id-label"><strong>ID del Inventario:</strong></p>
          <div class="id-contenedor">
            <span id="inventoryID">ID_Inventario</span>
            <button onclick="copiarID()">üìã</button>
          </div>
        </div>
        <div>
          <p class="descripcion-label"><strong>Descripci√≥n:</strong></p>
          <p class="descripcion-texto" id="descript">
            Aqu√≠ se mostrar√° la descripci√≥n que el usuario haya ingresado
          </p>
        </div>
      </div>

      <div class="tabla-container">
        <div class="tabla-container" id="tablaContenedor">
          <p id="mensajePlaceholder">Tu inventario se mostrar√° aqu√≠</p>
        </div>        
      </div>
    </section>
  </main>

  <script>

    //Cargar datos del inventario
    document.addEventListener("DOMContentLoaded", async function() {

      const inventactual = localStorage.getItem("inventarioActual");

      if (!inventactual) {
        console.error("No se encontr√≥ el ID del inventario en localStorage");
        return;
      }

      const host = window.location.hostname;
      const respuesta = await fetch(`http://${host}:3000/recuperarinventario/${inventactual}`);
      const data = await respuesta.json();

      const titulo = document.getElementById("nombreEncabezado");
      const desc = document.getElementById("descript");
      //Este no se obtiene de server.js, sino de memoria local
      const id = document.getElementById("inventoryID");

      titulo.innerText = data.nombre;
      desc.innerText = data.descripcion;
      id.innerText = inventactual;

    });

    //Cargar filas y columnas del inventario
    document.addEventListener("DOMContentLoaded", async () => {
      const inventarioId = localStorage.getItem("inventarioActual");
      if (!inventarioId) {
        document.getElementById("mensajePlaceholder").textContent = "No se ha seleccionado inventario.";
        return;
      }

      try {
        const host = window.location.hostname;
        const res = await fetch(`http://${host}:3000/api/inventario/obtener?inventarioId=${inventarioId}`);
        const { columnas, filas } = await res.json();

        const contenedor = document.getElementById("tablaContenedor");
        contenedor.innerHTML = "";

        // Crear tabla
        const tabla = document.createElement("table");
        tabla.id = "inventoryTable";

        // ==== THEAD ====
        const thead = document.createElement("thead");
        const trHead = document.createElement("tr");

        // Columna de borrar
        trHead.appendChild(document.createElement("th"));

        // Cabeceras din√°micas
        columnas.forEach(col => {
          const th = document.createElement("th");
          th.textContent = col;
          trHead.appendChild(th);
        });

        // Bot√≥n ‚ûï para agregar columna
        const thAdd = document.createElement("th");
        thAdd.innerHTML = `<button onclick="agregarColumna()">‚ûï</button>`;
        trHead.appendChild(thAdd);

        thead.appendChild(trHead);
        tabla.appendChild(thead);

        // ==== TBODY ====
        const tbody = document.createElement("tbody");

        // Filas de datos
        filas.forEach(filaObj => {
          const tr = document.createElement("tr");

          // Bot√≥n ‚ùå eliminar fila
          const tdDel = document.createElement("td");
          tdDel.innerHTML = `<button onclick="eliminarFila(this)">‚ùå</button>`;
          tr.appendChild(tdDel);

          // Celdas seg√∫n columnas
          columnas.forEach(col => {
            const td = document.createElement("td");
            td.textContent = filaObj.datos[col] || "";
            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        });

        // Fila ‚ûï para agregar nueva fila
        const trAdd = document.createElement("tr");
        trAdd.innerHTML = `<td><button onclick="agregarFila()">‚ûï</button></td>` +
                          `<td colspan="${columnas.length}"></td>`;
        tbody.appendChild(trAdd);

        tabla.appendChild(tbody);
        contenedor.appendChild(tabla);

        // Activa todos los manejadores de edici√≥n, b√∫squeda, etc.
        habilitarEdicionTabla();
      }
      catch (err) {
        console.error("Error cargando inventario:", err);
        document.getElementById("mensajePlaceholder").textContent = "Error al cargar inventario.";
      }
    });


    function copiarID() {
      const id = document.getElementById("inventoryID").innerText;
      navigator.clipboard.writeText(id);
    }
  </script>
  <script>
    function copiarID() {
      const id = document.getElementById("inventoryID").innerText;
      navigator.clipboard.writeText(id);
    }
  
    function searchTable() {
      const input = document.getElementById("searchInput");
      const filter = input.value.toLowerCase();
      const table = document.querySelector("table");
      const tr = table.getElementsByTagName("tr");
  
      for (let i = 1; i < tr.length; i++) {
        let visible = false;
        const td = tr[i].getElementsByTagName("td");
        for (let j = 0; j < td.length; j++) {
          if (td[j].innerText.toLowerCase().includes(filter)) {
            visible = true;
            break;
          }
        }
        tr[i].style.display = visible ? "" : "none";
      }
    }
  </script>
  
</body>
</html>
