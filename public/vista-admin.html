<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventario - Administrador</title>
  <link rel="stylesheet" href="vista_admin.css">
  <link href="https://fonts.googleapis.com/css2?family=Jost:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header class="encabezado">
    <h1>LATOSOS CO</h1>
    <img src="GuardianIcon.png" alt="Escudo" class="icono-escudo">
  </header>

  <main class="contenido">
    <section class="caja-principal">
      <div class="barra-superior">
        <button class="btn-regresar" onclick="window.location.href='seleccion_usuario.html'">&#8592;</button>

        <div class="busqueda">
          <input type="text" placeholder="Ingrese lo que desee buscar..." id="searchInput" onkeyup="searchTable()">
          <span class="btn-cerrar">√ó</span>
        </div>

        <div class="acciones"> 
          <button onclick="document.getElementById('importCSV').click()">Importar...</button>
          <input type="file" id="importCSV" accept=".csv" style="display: none;" onchange="importarCSV(event)">
          <button onclick="exportarCSV()">Exportar...</button>
          <button onclick="window.location.href='historial_cambios.html'">Historial de cambios</button>

        </div>

        <img src="Casco admin.jpg" class="icono-perfil" alt="Perfil">
      </div>

      <div class="info-inventario">
        <div>
          <p><strong>ID del Inventario:</strong></p>
          <div class="id-contenedor">
            <span id="inventoryID">45TYUY64XS</span>
            <button onclick="copiarID()">üìã</button>
          </div>
        </div>
        <div>
          <p><strong>Descripci√≥n:</strong></p>
          <p class="descripcion-texto">
            El inventario de llantas registra productos disponibles en distintas categor√≠as para venta directa y por encargo.
            Aqu√≠ se gestionan cantidades, rangos aceptables y precios por unidad.
          </p>
        </div>
      </div>

      <div class="tabla-container">
        <table id="inventoryTable">
          <thead>
              <tr>
                <th></th> <!-- Columna para eliminar -->
                <th>ID Producto</th>
                <th>Nombre</th>
                <th>Categor√≠a</th>
                <th>Descripci√≥n</th>
                <th>Cantidad</th>
                <th>M√≠nima</th>
                <th>M√°xima</th>
                <th>Precio Unitario</th>
                <th>Costo Unitario</th>
                <th>Unidad</th>
                <th>C√≥digo de Barras</th>
              </tr>
          </thead>
          <tbody>
            <tr>
              <td><button onclick="eliminarFila(this)">‚ùå</button></td>
              <td>2764238746923</td>
              <td>Llanta Goodyear</td>
              <td>Automotriz</td>
              <td>Llanta de alto rendimiento</td>
              <td>20</td>
              <td>10</td>
              <td>100</td>
              <td>$750</td>
              <td>$500</td>
              <td>Pieza</td>
              <td>7501031300072</td>
            </tr>
            <tr>
              <td><button onclick="eliminarFila(this)">‚ùå</button></td>
              <td>19630273977977</td>
              <td>Rin deportivo</td>
              <td>Accesorios</td>
              <td>Rin aluminio 16‚Äù</td>
              <td>12</td>
              <td>5</td>
              <td>50</td>
              <td>$1200</td>
              <td>$950</td>
              <td>Pieza</td>
              <td>7501234567890</td>
            </tr>
            <tr>
              <td><button onclick="eliminarFila(this)">‚ùå</button></td>
              <td>71236436737376</td>
              <td>Filtro de aceite</td>
              <td>Mantenimiento</td>
              <td>Filtro motor est√°ndar</td>
              <td>50</td>
              <td>20</td>
              <td>200</td>
              <td>$150</td>
              <td>$100</td>
              <td>Pieza</td>
              <td>7509999999999</td>
            </tr>
            <tr>
              <td>
                <button onclick="agregarFila()">‚ûï</button>
              </td>
              <td colspan="11"></td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    function copiarID() {
      const id = document.getElementById('inventoryID').innerText;
      navigator.clipboard.writeText(id);
    }

    function searchTable() {
      const input = document.getElementById("searchInput");
      const filter = input.value.toLowerCase();
      const table = document.getElementById("inventoryTable");
      const tr = table.getElementsByTagName("tr");

      for (let i = 1; i < tr.length; i++) {
        let visible = false;
        const td = tr[i].getElementsByTagName("td");
        for (let j = 0; j < td.length; j++) {
          if (td[j].innerText.toLowerCase().includes(filter)) {
            visible = true;
            break;
          }
        }
        tr[i].style.display = visible ? "" : "none";
      }
    }

    function eliminarFila(boton) {
    const fila = boton.closest("tr");
    registrarCambioHistorial(null, "ELIMINAR");
    fila.remove();
  }

  function agregarFila() {
    const tabla = document.getElementById("inventoryTable").getElementsByTagName("tbody")[0];
    const nuevaFila = document.createElement("tr");

    nuevaFila.innerHTML = `
      <td><button onclick="eliminarFila(this)">‚ùå</button></td>
      <td><input type="text" /></td>
      <td><input type="text" /></td>
      <td><input type="text" /></td>
      <td><input type="text" /></td>
      <td><input type="text" /></td>
      <td><input type="text" /></td>
      <td><input type="text" /></td>
      <td><input type="text" /></td>
      <td><input type="text" /></td>
      <td><input type="text" /></td>
      <td><input type="text" /></td>
    `;

    tabla.insertBefore(nuevaFila, tabla.lastElementChild);

    const inputs = nuevaFila.querySelectorAll("input");
    inputs.forEach(input => {
      input.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          const valores = Array.from(inputs).map(i => i.value.trim());
          if (valores.some(v => v === "")) {
            alert("Por favor, completa todos los campos antes de guardar.");
            return;
          }
          // Reemplazar inputs por texto plano
          valores.forEach((valor, index) => {
            const td = inputs[index].parentElement;
            td.textContent = valor;
          });
          // Agregar nueva fila vac√≠a
          agregarFila();
          registrarCambioHistorial(null, "AGREGAR");
        }
      });
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    const tabla = document.getElementById("inventoryTable");

    tabla.addEventListener("dblclick", function (e) {
    const celda = e.target;
    if (celda.tagName.toLowerCase() === "td" && !celda.querySelector("input")) {
      const valorOriginal = celda.textContent;
      const input = document.createElement("input");
      input.type = "text";
      input.value = valorOriginal;
      celda.textContent = "";
      celda.appendChild(input);
      input.focus();

      let guardado = false; // ‚ö†Ô∏è Control para evitar doble guardado

      const guardarCambio = () => {
        const nuevoValor = input.value.trim();
        if (!guardado && nuevoValor !== valorOriginal.trim()) {
          guardado = true;
          const th = celda.closest("table").querySelectorAll("th")[celda.cellIndex];
          const nombreColumna = th ? th.innerText : null;
          registrarCambioHistorial(nombreColumna, "MODIFICACION");
        }
        celda.textContent = nuevoValor;
      };

      input.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          guardarCambio();
        }
      });

      input.addEventListener("blur", function () {
        guardarCambio();
      });
    }
  });

  });

  function exportarCSV() {
  const tabla = document.getElementById("inventoryTable");
  let csv = [];
  const filas = tabla.querySelectorAll("tbody tr");

  for (let fila of filas) {
    // Ignorar la fila del bot√≥n ‚ûï
    if (fila.querySelector("button[onclick*='agregarFila']")) continue;

    const celdas = fila.querySelectorAll("td");
    let filaCSV = [];

    for (let i = 1; i < celdas.length; i++) { // empieza desde 1 para saltar la celda de eliminar
      const celda = celdas[i];
      const input = celda.querySelector("input");
      if (input) {
        filaCSV.push(`"${input.value.trim()}"`);
      } else {
        filaCSV.push(`"${celda.textContent.trim()}"`);
      }
    }

    if (filaCSV.length > 0) {
      csv.push(filaCSV.join(","));
    }
  }

    // Encabezados definidos manualmente
    const encabezado = [
      "ID Producto", "Nombre", "Categor√≠a", "Descripci√≥n",
      "Cantidad", "M√≠nima", "M√°xima",
      "Precio Unitario", "Costo Unitario", "Unidad", "C√≥digo de Barras"
    ].join(",");

    const contenidoCSV = [encabezado, ...csv].join("\n");
    const blob = new Blob([contenidoCSV], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "inventario.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    registrarCambioHistorial(null, "EXPORTAR");
  }


  function importarCSV(event) {
    const archivo = event.target.files[0];
    if (!archivo || !archivo.name.endsWith(".csv")) {
      alert("Por favor selecciona un archivo CSV v√°lido.");
      return;
    }

    const reader = new FileReader();
    reader.onload = function (e) {
      const contenido = e.target.result.trim();
      const lineas = contenido.split("\n");

      const columnasEsperadas = 11;
      const tabla = document.getElementById("inventoryTable");
      const tbody = tabla.querySelector("tbody");

      // Eliminar todas las filas excepto la del bot√≥n ‚ûï
      const filas = Array.from(tbody.querySelectorAll("tr"));
      filas.forEach(f => {
        if (!f.querySelector("button[onclick*='agregarFila']")) f.remove();
      });

      for (let i = 1; i < lineas.length; i++) {
        const linea = lineas[i];
        const datos = linea.split(",").map(d => d.replace(/"/g, "").trim());
        if (datos.length === 12 && datos[0] === "") datos.shift(); // Quita la celda vac√≠a


        if (datos.length !== columnasEsperadas) {
          alert("El archivo no tiene el formato correcto. Se esperaban 11 columnas por fila.");
          return;
        }

        const nuevaFila = document.createElement("tr");
        nuevaFila.innerHTML = `
          <td><button onclick="eliminarFila(this)">‚ùå</button></td>
          ${datos.map(d => `<td>${d}</td>`).join("")}
        `;
        tbody.insertBefore(nuevaFila, tbody.lastElementChild);
      }

      event.target.value = "";
    };

    reader.readAsText(archivo);
    registrarCambioHistorial(null, "IMPORTAR");
  }
  // Funci√≥n para obtener fecha en formato DD/MM/YY
  function obtenerFechaActual() {
    const hoy = new Date();
    return hoy.toLocaleDateString("es-ES");
  }

  // Funci√≥n para guardar un nuevo cambio en localStorage
  function registrarCambioHistorial(columna, tipoAccion) {
    const historial = JSON.parse(localStorage.getItem("historialCambios")) || [];
    const nuevoCambio = {
      id: historial.length,
      columna_afectada: columna || null,
      fecha_accion: obtenerFechaActual(),
      id_inventario: document.getElementById("inventoryID").innerText.trim(),
      id_usuario: null, // se puede actualizar m√°s adelante si se tiene login
      tipo_accion: tipoAccion
    };
    historial.push(nuevoCambio);
    localStorage.setItem("historialCambios", JSON.stringify(historial));
  }


  </script>
</body>
</html>
